# MP4视频智能修复工具

## 能解决什么问题？

### 核心问题诊断
1. **在线vs本地差异** = 容器格式/时间戳兼容性问题
2. **静止画面** = 编码器异常或时间戳重置错误
3. **画面抽搐** = GOP结构损坏 + 时间戳不连续
4. **FFmpeg截断** = moov atom位置错误或时间戳溢出

### 适用症状
- 在线播放正常，下载后本地抽搐
- 画面长时间静止，但音频继续
- 音画不同步
- FFmpeg处理时莫名截断
- 时间戳异常导致播放器卡死

---

## 我的经历

**问题来源：** 从聊天软件收到一个15分钟的视频

### 在线观看表现
- 0:00 - 0:30：正常
- 0:28开始：画面静止，音频继续
- 7:20：画面恢复，音画不同步
- 11:00后：音频继续，但声音消失

### 本地播放表现
- 上述问题全部存在
- 画面恢复时（7:20）开始抽搐：画面跳动、撕裂、运动不连贯

### 尝试过的解决方法
- 换多个播放器：无效
- FFmpeg转码：中途截断
- 决定自己写脚本修复

---

## 使用前必读

### 三条最重要
1. **脚本和视频必须在同一目录**
2. **必须先安装FFmpeg和Python3**：`pkg install ffmpeg python`
3. **Termux必须授权存储**：`termux-setup-storage`

### 环境要求
- Android Termux（主要适配）
- Linux/macOS终端
- Windows WSL2或Git Bash
- 不支持纯Windows CMD

---

## 快速开始

### Termux三步法

```bash
# 1. 安装环境
termux-setup-storage
pkg update && pkg upgrade -y
pkg install ffmpeg python -y

# 2. 下载脚本到视频目录
cd ~/storage/movies/Telegram  # 你的视频目录
# 下载脚本到这个目录（下面有详细方法）

# 3. 运行修复
python3 fix_video.py 你的视频.mp4
# 生成：你的视频_fixed.mp4
```

---

## 详细使用说明

### 基本用法

```bash
# 最简单用法（自动生成 xxx_fixed.mp4）
python3 fix_video.py input_video.mp4

# 指定输出文件名
python3 fix_video.py input_video.mp4 output_fixed.mp4

# 批量修复当前目录所有视频
for f in *.mp4; do python3 fix_video.py "$f"; done
```

### Termux文件路径说明

```
手机存储根目录：/storage/emulated/0/
下载目录：      ~/storage/downloads/
视频目录：      ~/storage/movies/
相册目录：      ~/storage/dcim/
```

**注意：** 脚本必须在视频所在目录执行

### 修复过程输出示例

```
============================================================
🔍 完整分析
============================================================
📋 获取信息...
  时长: 900.0秒
  编码: h264 (High)
  像素: yuv420p
❄️  检测静止段...
  ⚠️ 发现 1 个静止段
    0:28-7:20 (424.4秒)
📦 检查容器...
  🔴 moov位置不当（影响在线播放）
🎯 检查兼容性...
  ✅ 时间戳正常

🤖 制定方案...
  策略: full_fix

============================================================
📋 修复计划
============================================================
  1. 删除静止段
  2. 修复容器结构
  3. 标准化编码（修复抽搐）

============================================================
🔧 开始修复
============================================================
🔨 完整修复...
  多段处理 (2段)...
  处理 1/2...
  00:00:15
  处理 2/2...
  00:07:12
  🔗 合并...

============================================================
✅ 完成
============================================================
输出: video_fixed.mp4
大小: 125.30 MB
```

---

## 技术细节

### 静止检测算法
```python
'-vf', 'freezedetect=n=-60dB:d=2.5'
# n=-60dB: 噪声阈值
# d=2.5: 最小静止时长（秒）
```

### 抽搐修复关键参数
```python
'-vsync', 'cfr'          # 强制恒定帧率
'-g', '30'               # 固定GOP长度
'-sc_threshold', '0'     # 禁用场景检测
'-keyint_min', '15'      # 最小关键帧间隔
'-bf', '2'               # 限制B帧数量
```

### 兼容性优化
```python
'-movflags', '+faststart'  # moov前置
'-pix_fmt', 'yuv420p'      # 标准化像素格式
'-profile:v', 'high'       # 兼容Profile
'-level', '4.0'            # 标准Level
```

---

## 常见问题

### Q1: 找不到python3
```bash
pkg install python -y
```

### Q2: 找不到ffmpeg
```bash
pkg install ffmpeg -y
```

### Q3: 权限被拒绝
```bash
termux-setup-storage
```

### Q4: 修复后文件很大
正常现象，重编码会损失压缩效率。可修改脚本中 `-crf 23` 为 `-crf 28` 提高压缩率。

### Q5: 如何只删除静止段不重编码
修改 `_decide()` 函数的逻辑，强制使用 `remove_freeze` 策略。

---

## 项目结构

```
mp4-video-fixer/
├── fix_video.py          # 主修复脚本
├── README.md             # 说明文档
├── LICENSE               # MIT许可证
├── requirements.txt      # 依赖说明
└── .gitignore           # Git忽略配置
```

---

## 许可证

MIT License
